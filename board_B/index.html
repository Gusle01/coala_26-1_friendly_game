<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì¹œí•´ì§€ê¸¸ ë°”ë¼ - Bì•ˆ ìœ· ë ˆì´ìŠ¤</title>
  <style>
    :root {
      --bg: #eef4e7;
      --paper: #f9fdf5;
      --ink: #1d2218;
      --line: #bfccb0;
      --primary: #2f6f4e;
      --primary-dark: #1f4a35;
      --accent: #d0671f;
      --track: #f3e0b9;
      --track-line: #dfc690;
      --good: #0f6a4b;
      --warn: #7d4f00;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Pretendard", "Noto Sans KR", sans-serif;
      color: var(--ink);
      min-height: 100vh;
      background:
        radial-gradient(circle at 15% 8%, #dbe9cf 0%, transparent 32%),
        radial-gradient(circle at 88% 82%, #cce0bd 0%, transparent 30%),
        var(--bg);
      padding: 20px;
    }

    .container {
      max-width: 1180px;
      margin: 0 auto;
      display: grid;
      gap: 16px;
    }

    .hero {
      background: linear-gradient(140deg, #f8fde8, #dcecc6);
      border: 2px solid #bdd0a2;
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 10px 22px rgba(0,0,0,0.06);
    }

    .hero h1 {
      margin: 0 0 8px;
      font-size: clamp(1.5rem, 3vw, 2.1rem);
    }

    .hero p {
      margin: 0;
      font-size: 0.95rem;
      line-height: 1.5;
    }

    .grid {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(12, 1fr);
    }

    .card {
      background: var(--paper);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 6px 14px rgba(0,0,0,0.05);
    }

    .card h2 {
      margin: 0 0 12px;
      font-size: 1.02rem;
    }

    .col-3 { grid-column: span 3; }
    .col-4 { grid-column: span 4; }
    .col-5 { grid-column: span 5; }
    .col-7 { grid-column: span 7; }
    .col-8 { grid-column: span 8; }
    .col-12 { grid-column: span 12; }

    label {
      display: block;
      margin-bottom: 6px;
      font-size: 0.84rem;
      font-weight: 700;
    }

    input, select, button {
      width: 100%;
      border: 1px solid #b8c8aa;
      background: #fff;
      border-radius: 10px;
      padding: 10px;
      font-size: 0.92rem;
    }

    button {
      border: 0;
      background: var(--primary);
      color: #fff;
      font-weight: 700;
      cursor: pointer;
      transition: transform .12s ease, background .2s ease;
    }

    button:hover { background: var(--primary-dark); }
    button:active { transform: translateY(1px); }

    .accent-btn { background: var(--accent); }

    .row-2 {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 10px;
    }

    .row-3 {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 10px;
    }

    .hint {
      font-size: 0.82rem;
      color: #46533a;
      line-height: 1.4;
      margin-top: 6px;
    }

    .pill {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 0.74rem;
      font-weight: 700;
      margin-left: 6px;
    }

    .pill.good { background: #d7f0e3; color: var(--good); }
    .pill.warn { background: #ffeecb; color: var(--warn); }

    .yut-result {
      margin-top: 10px;
      padding: 10px;
      border-radius: 10px;
      border: 1px dashed #c8b48a;
      background: #fff9ef;
      font-size: 0.9rem;
      min-height: 44px;
      display: flex;
      align-items: center;
    }

    .race-board {
      display: grid;
      gap: 10px;
    }

    .track-row {
      display: grid;
      grid-template-columns: 140px 1fr;
      gap: 10px;
      align-items: center;
    }

    .team-tag {
      font-size: 0.86rem;
      font-weight: 700;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .track {
      position: relative;
      height: 36px;
      border-radius: 999px;
      border: 1px solid var(--track-line);
      background:
        repeating-linear-gradient(
          90deg,
          #f6e7c7,
          #f6e7c7 20px,
          var(--track) 20px,
          var(--track) 40px
        );
      overflow: hidden;
    }

    .checkpoints {
      position: absolute;
      left: 0;
      right: 0;
      top: 0;
      height: 100%;
      pointer-events: none;
    }

    .checkpoint {
      position: absolute;
      top: 4px;
      transform: translateX(-50%);
      display: flex;
      flex-direction: column;
      align-items: center;
      line-height: 1;
      opacity: 0.9;
    }

    .checkpoint-icon {
      font-size: 0.7rem;
    }

    .checkpoint-label {
      margin-top: 1px;
      font-size: 0.58rem;
      font-weight: 700;
      color: #6a4d13;
    }

    .token {
      position: absolute;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(160deg, #2f6f4e, #56a66f);
      color: #fff;
      font-weight: 700;
      font-size: 0.75rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid #fff;
      box-shadow: 0 3px 8px rgba(0,0,0,0.18);
      transition: left .35s ease;
    }

    .flag {
      position: absolute;
      right: 10px;
      top: 8px;
      font-size: 0.92rem;
      opacity: 0.9;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    th, td {
      text-align: left;
      padding: 10px;
      border-bottom: 1px solid #dde7d1;
    }

    th {
      font-size: 0.8rem;
      color: #4f5a44;
    }

    .rank {
      width: 40px;
      text-align: center;
      font-weight: 700;
    }

    .logs {
      max-height: 310px;
      overflow: auto;
      border: 1px solid #d9e5cc;
      border-radius: 10px;
      background: #fff;
    }

    .log-item {
      font-size: 0.86rem;
      line-height: 1.4;
      padding: 10px;
      border-bottom: 1px solid #edf3e6;
    }

    .log-item:last-child { border-bottom: 0; }

    .danger {
      margin-top: 8px;
      background: #97381a;
    }

    @media (max-width: 900px) {
      .col-3, .col-4, .col-5, .col-7, .col-8, .col-12 { grid-column: span 12; }
      .row-2, .row-3 { grid-template-columns: 1fr; }
      .track-row { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <main class="container">
    <section class="hero">
      <h1>ì¹œí•´ì§€ê¸¸ ë°”ë¼ - Bì•ˆ ìœ· ë ˆì´ìŠ¤</h1>
      <p>
        í™œë™ì„ ì™„ë£Œí•˜ë©´ ì ìˆ˜ë¥¼ ì–»ê³  <b>ìœ· ë˜ì§€ê¸° ê¸°íšŒ</b>ë¥¼ ìŒ“ìŠµë‹ˆë‹¤. ë˜ì§„ ê²°ê³¼ë§Œí¼ ë§ì´ ì „ì§„í•˜ë©°,
        ìƒëŒ€ë¥¼ ì¡ìœ¼ë©´ ë³´ë„ˆìŠ¤ê°€ ìƒê¹ë‹ˆë‹¤. ë¨¼ì € ê²°ìŠ¹ì— ê°€ê¹Œì›Œì§€ë©´ì„œ ë†’ì€ ì ìˆ˜ë¥¼ ëª¨ì€ íŒ€ì´ ìš°ìŠ¹í•©ë‹ˆë‹¤.
      </p>
    </section>

    <section class="grid">
      <article class="card col-4">
        <h2>íŒ€ ë“±ë¡</h2>
        <div class="row-2">
          <div>
            <label for="teamName">íŒ€ëª…</label>
            <input id="teamName" placeholder="ì˜ˆ: 2ì¡° ì½”ì•Œë¼" />
          </div>
          <div style="display:flex;align-items:end;">
            <button id="addTeamBtn">íŒ€ ì¶”ê°€</button>
          </div>
        </div>
        <div class="hint">ì¤‘ë³µ íŒ€ëª…ì€ ë“±ë¡ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>
      </article>

      <article class="card col-8">
        <h2>í™œë™ ê¸°ë¡ (ì ìˆ˜ íšë“)</h2>
        <div class="row-3">
          <div>
            <label for="missionTeam">í™œë™ íŒ€</label>
            <select id="missionTeam"></select>
          </div>
          <div>
            <label for="participantCount">ì°¸ì—¬ ì¸ì›</label>
            <input id="participantCount" type="number" min="1" value="2" />
          </div>
          <div>
            <label for="difficulty">ë‚œì´ë„</label>
            <select id="difficulty">
              <option value="easy">ì‰¬ì›€ (+10)</option>
              <option value="medium" selected>ë³´í†µ (+20)</option>
              <option value="hard">ì–´ë ¤ì›€ (+30)</option>
            </select>
          </div>
        </div>

        <div class="row-3">
          <div>
            <label for="category">ì¹´í…Œê³ ë¦¬</label>
            <select id="category">
              <option value="talk">ëŒ€í™”</option>
              <option value="teamplay">í˜‘ë™</option>
              <option value="help">ë„ì›€</option>
              <option value="challenge">ë„ì „</option>
            </select>
          </div>
          <div>
            <label for="missionTitle">í™œë™ ì´ë¦„</label>
            <input id="missionTitle" placeholder="ì˜ˆ: ëœë¤ íŒ€ ì¸í„°ë·°" />
          </div>
          <div style="display:flex;align-items:end;">
            <button id="recordMissionBtn">í™œë™ ë°˜ì˜</button>
          </div>
        </div>

        <div class="hint">
          ê¸°ë³¸ 10ì  + ë‚œì´ë„ ì ìˆ˜(10/20/30) + ì°¸ì—¬ ì¸ì› ë³´ë„ˆìŠ¤(3ëª… ì´ìƒ 1ëª…ë‹¹ +20).
          ëˆ„ì  ì ìˆ˜ 40ì ë§ˆë‹¤ ë˜ì§€ê¸° ê¸°íšŒ +1.
          ì¹´í…Œê³ ë¦¬ 4ì¢… ì™„ë£Œ ì‹œ +40, ì¹´í…Œê³ ë¦¬ 3íšŒë§ˆë‹¤ +25 ë³´ë„ˆìŠ¤.
        </div>
      </article>

      <article class="card col-12">
        <h2>ìœ· ë ˆì´ìŠ¤ íŠ¸ë™ (ì´ 50ì¹¸)</h2>
        <div id="raceBoard" class="race-board"></div>
      </article>

      <article class="card col-7">
        <h2>ìœ· ë˜ì§€ê¸°</h2>
        <div class="row-2">
          <div>
            <label for="throwTeam">ë˜ì§ˆ íŒ€</label>
            <select id="throwTeam"></select>
          </div>
          <div style="display:flex;align-items:end;">
            <button id="throwBtn" class="accent-btn">ìœ· ë˜ì§€ê¸°</button>
          </div>
        </div>
        <div class="hint">
          ë„(1), ê°œ(2), ê±¸(3), ìœ·(4), ëª¨(5), ë¹½ë„(-1).
          ìœ·/ëª¨ëŠ” ì¶”ê°€ ë˜ì§€ê¸° +1, ìƒëŒ€ ë§ì„ ì¡ìœ¼ë©´ +30ì  + ì¶”ê°€ ë˜ì§€ê¸° +1.
          ì¡íŒ íŒ€ì€ ì‹œì‘ì ì´ ì•„ë‹ˆë¼ ë§ˆì§€ë§‰ 10ì¹¸ ì²´í¬í¬ì¸íŠ¸ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤.
        </div>
        <div id="yutResult" class="yut-result">ì•„ì§ ë˜ì§€ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</div>
      </article>

      <article class="card col-5">
        <h2>ì‹¤ì‹œê°„ ë­í‚¹</h2>
        <table>
          <thead>
            <tr>
              <th class="rank">ìˆœìœ„</th>
              <th>íŒ€</th>
              <th>ì ìˆ˜</th>
              <th>ìœ„ì¹˜</th>
              <th>ë˜ì§€ê¸°</th>
            </tr>
          </thead>
          <tbody id="rankingBody"></tbody>
        </table>
      </article>

      <article class="card col-8">
        <h2>ìµœê·¼ ë¡œê·¸</h2>
        <div id="logs" class="logs"></div>
      </article>

      <article class="card col-4">
        <h2>ê²Œì„ ê´€ë¦¬</h2>
        <div class="hint">í˜„ì¬ ìƒíƒœë¥¼ ë¸Œë¼ìš°ì € ë¡œì»¬ ì €ì¥ì†Œì— ì €ì¥í•©ë‹ˆë‹¤.</div>
        <button id="resetBtn" class="danger">ê²Œì„ ì´ˆê¸°í™”</button>
      </article>
    </section>
  </main>

  <script>
    const STORAGE_KEY = "friendlyGameB";
    const FINISH_POS = 50;
    const BASE_POINTS = 10;
    const TEAM_MEMBER_BONUS_POINTS = 20;
    const TEAM_MEMBER_BONUS_START = 3;
    const SCORE_PER_THROW = 40;
    const CHECKPOINT_INTERVAL = 10;
    const DIFFICULTY_POINTS = { easy: 10, medium: 20, hard: 30 };
    const SET_BONUS_POINTS = 40;
    const LINE_BONUS_POINTS = 25;
    const LINE_THRESHOLD = 3;
    const CATEGORIES = ["talk", "teamplay", "help", "challenge"];

    const YUT_OUTCOMES = [
      { key: "do", label: "ë„", step: 1, weight: 34, extraThrow: 0 },
      { key: "gae", label: "ê°œ", step: 2, weight: 26, extraThrow: 0 },
      { key: "geol", label: "ê±¸", step: 3, weight: 17, extraThrow: 0 },
      { key: "yut", label: "ìœ·", step: 4, weight: 11, extraThrow: 1 },
      { key: "mo", label: "ëª¨", step: 5, weight: 8, extraThrow: 1 },
      { key: "backdo", label: "ë¹½ë„", step: -1, weight: 4, extraThrow: 0 }
    ];

    const state = {
      teams: [],
      logs: [],
      finishOrder: []
    };

    function uid() {
      return Date.now().toString(36) + Math.random().toString(36).slice(2, 7);
    }

    function createTeam(name) {
      return {
        id: uid(),
        name,
        score: 0,
        missionCount: 0,
        throwChance: 0,
        throwGrantedByScore: 0,
        position: 0,
        finishedAt: null,
        categoryCount: {
          talk: 0,
          teamplay: 0,
          help: 0,
          challenge: 0
        },
        setBonusTaken: 0,
        lineBonusTaken: {
          talk: 0,
          teamplay: 0,
          help: 0,
          challenge: 0
        }
      };
    }

    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function normalizeLoadedState(parsed) {
      if (!Array.isArray(parsed.teams) || !Array.isArray(parsed.logs)) return false;
      state.teams = parsed.teams.map((team) => ({
        ...createTeam(team.name || "ì´ë¦„ì—†ìŒ"),
        ...team,
        throwGrantedByScore: Number.isInteger(team.throwGrantedByScore) ? team.throwGrantedByScore : Math.floor((team.score || 0) / SCORE_PER_THROW)
      }));
      state.logs = parsed.logs;
      state.finishOrder = Array.isArray(parsed.finishOrder) ? parsed.finishOrder : [];
      return true;
    }

    function loadState() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      try {
        const parsed = JSON.parse(raw);
        if (!normalizeLoadedState(parsed)) {
          localStorage.removeItem(STORAGE_KEY);
        }
      } catch (_) {
        localStorage.removeItem(STORAGE_KEY);
      }
    }

    function byId(id) {
      return state.teams.find((t) => t.id === id);
    }

    function addLog(text) {
      state.logs.unshift({ id: uid(), text, at: new Date().toISOString() });
      state.logs = state.logs.slice(0, 120);
    }

    function computeBonus(team) {
      let bonus = 0;
      const allDone = CATEGORIES.every((c) => team.categoryCount[c] > 0);
      if (allDone && team.setBonusTaken === 0) {
        bonus += SET_BONUS_POINTS;
        team.setBonusTaken = 1;
      }

      CATEGORIES.forEach((c) => {
        const ready = Math.floor(team.categoryCount[c] / LINE_THRESHOLD);
        if (ready > team.lineBonusTaken[c]) {
          const gained = ready - team.lineBonusTaken[c];
          bonus += gained * LINE_BONUS_POINTS;
          team.lineBonusTaken[c] = ready;
        }
      });
      return bonus;
    }

    function applyScoreThrowMilestone(team) {
      const eligible = Math.floor(team.score / SCORE_PER_THROW);
      if (eligible > team.throwGrantedByScore) {
        const gained = eligible - team.throwGrantedByScore;
        team.throwChance += gained;
        team.throwGrantedByScore = eligible;
        addLog(`${team.name}: ëˆ„ì  ${SCORE_PER_THROW}ì  ë‹¬ì„± ë³´ë„ˆìŠ¤, ë˜ì§€ê¸° +${gained}`);
      }
    }

    function addTeam() {
      const input = document.getElementById("teamName");
      const name = input.value.trim();
      if (!name) {
        alert("íŒ€ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }

      if (state.teams.some((t) => t.name === name)) {
        alert("ì´ë¯¸ ê°™ì€ íŒ€ëª…ì´ ìˆìŠµë‹ˆë‹¤.");
        return;
      }

      state.teams.push(createTeam(name));
      input.value = "";
      saveState();
      renderAll();
    }

    function recordMission() {
      const teamId = document.getElementById("missionTeam").value;
      const participantCount = Number(document.getElementById("participantCount").value);
      const difficulty = document.getElementById("difficulty").value;
      const category = document.getElementById("category").value;
      const title = document.getElementById("missionTitle").value.trim();

      if (!teamId) {
        alert("í™œë™ íŒ€ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
        return;
      }
      if (!Number.isInteger(participantCount) || participantCount < 1) {
        alert("ì°¸ì—¬ ì¸ì›ì€ 1ëª… ì´ìƒì˜ ì •ìˆ˜ì—¬ì•¼ í•©ë‹ˆë‹¤.");
        return;
      }

      const team = byId(teamId);
      if (!team) return;

      const extraMembers = Math.max(0, participantCount - (TEAM_MEMBER_BONUS_START - 1));
      const memberBonus = extraMembers * TEAM_MEMBER_BONUS_POINTS;
      const earned = BASE_POINTS + (DIFFICULTY_POINTS[difficulty] || 0) + memberBonus;
      team.score += earned;
      team.missionCount += 1;
      team.categoryCount[category] += 1;

      const bonus = computeBonus(team);
      if (bonus > 0) team.score += bonus;
      applyScoreThrowMilestone(team);

      const detail = title ? ` [${title}]` : "";
      const memberBonusText = memberBonus > 0 ? `, ì¸ì›ë³´ë„ˆìŠ¤ +${memberBonus}ì ` : "";
      const bonusText = bonus > 0 ? ` + ë³´ë„ˆìŠ¤ ${bonus}ì ` : "";
      addLog(`${team.name}${detail}: í™œë™ +${earned}ì ${memberBonusText}${bonusText}`);

      document.getElementById("missionTitle").value = "";
      saveState();
      renderAll();
    }

    function drawYut() {
      const total = YUT_OUTCOMES.reduce((sum, item) => sum + item.weight, 0);
      let r = Math.random() * total;
      for (const item of YUT_OUTCOMES) {
        r -= item.weight;
        if (r <= 0) return item;
      }
      return YUT_OUTCOMES[0];
    }

    function ensureFinish(team) {
      if (team.position >= FINISH_POS && !team.finishedAt) {
        team.position = FINISH_POS;
        team.finishedAt = new Date().toISOString();
        state.finishOrder.push(team.id);
        team.score += 50;
        applyScoreThrowMilestone(team);
        addLog(`${team.name} ê²°ìŠ¹ ë„ì°©! ìˆœìœ„ ë³´ë„ˆìŠ¤ +50ì `);
      }
    }

    function captureOpponents(actor) {
      if (actor.position <= 0 || actor.position >= FINISH_POS) return;
      const captured = state.teams.filter((t) => t.id !== actor.id && t.position === actor.position && !t.finishedAt);
      if (captured.length === 0) return;

      captured.forEach((enemy) => {
        const checkpoint = Math.floor(enemy.position / CHECKPOINT_INTERVAL) * CHECKPOINT_INTERVAL;
        enemy.position = checkpoint;
        addLog(`${actor.name}ì´(ê°€) ${enemy.name} ë§ì„ ì¡ì•˜ìŠµë‹ˆë‹¤. (${enemy.name} ${checkpoint}ì¹¸ ì²´í¬í¬ì¸íŠ¸ë¡œ ë³µê·€)`);
      });

      actor.score += 30 * captured.length;
      actor.throwChance += captured.length;
      applyScoreThrowMilestone(actor);
      addLog(`${actor.name}: ì¡ê¸° ë³´ë„ˆìŠ¤ +${30 * captured.length}ì , ì¶”ê°€ ë˜ì§€ê¸° +${captured.length}`);
    }

    function throwYut() {
      const teamId = document.getElementById("throwTeam").value;
      const resultView = document.getElementById("yutResult");

      if (!teamId) {
        alert("ë˜ì§ˆ íŒ€ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
        return;
      }

      const team = byId(teamId);
      if (!team) return;
      if (team.finishedAt) {
        alert("ì´ë¯¸ ì™„ì£¼í•œ íŒ€ì…ë‹ˆë‹¤.");
        return;
      }
      if (team.throwChance <= 0) {
        alert("ë˜ì§€ê¸° ê¸°íšŒê°€ ì—†ìŠµë‹ˆë‹¤. í™œë™ì„ ë¨¼ì € ì™„ë£Œí•´ì£¼ì„¸ìš”.");
        return;
      }

      const yut = drawYut();
      team.throwChance -= 1;
      team.position = Math.max(0, team.position + yut.step);
      ensureFinish(team);

      if (!team.finishedAt) {
        captureOpponents(team);
      }

      if (yut.extraThrow > 0) {
        team.throwChance += yut.extraThrow;
      }

      const stepText = yut.step > 0 ? `+${yut.step}` : `${yut.step}`;
      const extraText = yut.extraThrow > 0 ? `, ì¶”ê°€ ë˜ì§€ê¸° +${yut.extraThrow}` : "";
      resultView.textContent = `${team.name}: ${yut.label} (${stepText}ì¹¸)${extraText}`;
      addLog(`${team.name} ìœ· ê²°ê³¼: ${yut.label}(${stepText}ì¹¸)${extraText}`);

      saveState();
      renderAll();
    }

    function sortedTeams() {
      return [...state.teams].sort((a, b) => {
        const aFinish = a.finishedAt ? state.finishOrder.indexOf(a.id) : Infinity;
        const bFinish = b.finishedAt ? state.finishOrder.indexOf(b.id) : Infinity;
        if (aFinish !== bFinish) return aFinish - bFinish;
        return b.score - a.score || b.position - a.position || b.missionCount - a.missionCount;
      });
    }

    function renderSelects() {
      const missionTeam = document.getElementById("missionTeam");
      const throwTeam = document.getElementById("throwTeam");
      const options = ["<option value=''>ì„ íƒ</option>"]
        .concat(state.teams.map((t) => `<option value="${t.id}">${t.name}</option>`))
        .join("");

      missionTeam.innerHTML = options;
      throwTeam.innerHTML = options;
    }

    function renderRace() {
      const raceBoard = document.getElementById("raceBoard");
      if (state.teams.length === 0) {
        raceBoard.innerHTML = `<div class="hint">íŒ€ì„ ë“±ë¡í•˜ë©´ íŠ¸ë™ì´ í™œì„±í™”ë©ë‹ˆë‹¤.</div>`;
        return;
      }

      const sorted = sortedTeams();
      const checkpoints = [];
      for (let point = CHECKPOINT_INTERVAL; point < FINISH_POS; point += CHECKPOINT_INTERVAL) {
        const left = (point / FINISH_POS) * 100;
        checkpoints.push(
          `<div class="checkpoint" style="left:${left}%;" title="${point}ì¹¸ ì²´í¬í¬ì¸íŠ¸">` +
          `<span class="checkpoint-icon">ğŸ¨</span><span class="checkpoint-label">${point}</span></div>`
        );
      }
      const checkpointsHtml = checkpoints.join("");

      raceBoard.innerHTML = sorted.map((team, idx) => {
        const progress = Math.max(0, Math.min(100, (team.position / FINISH_POS) * 100));
        const left = progress < 4 ? 4 : progress > 97 ? 97 : progress;
        const finishMark = team.finishedAt ? `<span class="pill good">ì™„ì£¼</span>` : "";
        return `
          <div class="track-row">
            <div class="team-tag">${idx + 1}ìœ„ ${team.name} ${finishMark}</div>
            <div class="track">
              <div class="checkpoints">${checkpointsHtml}</div>
              <div class="token" style="left:${left}%">${team.position}</div>
              <div class="flag">ğŸ</div>
            </div>
          </div>
        `;
      }).join("");
    }

    function renderRanking() {
      const tbody = document.getElementById("rankingBody");
      if (state.teams.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5">íŒ€ì„ ë¨¼ì € ë“±ë¡í•´ì£¼ì„¸ìš”.</td></tr>`;
        return;
      }

      const sorted = sortedTeams();
      tbody.innerHTML = sorted.map((team, idx) => {
        const gap = idx > 0 ? sorted[0].score - team.score : 0;
        const chase = idx > 0 && gap <= 40 ? `<span class="pill warn">ì¶”ê²©ê¶Œ</span>` : "";
        return `
          <tr>
            <td class="rank">${idx + 1}</td>
            <td>${team.name} ${chase}</td>
            <td><b>${team.score}</b>ì </td>
            <td>${team.position}/${FINISH_POS}</td>
            <td>${team.throwChance}íšŒ</td>
          </tr>
        `;
      }).join("");
    }

    function renderLogs() {
      const logs = document.getElementById("logs");
      if (state.logs.length === 0) {
        logs.innerHTML = `<div class="log-item">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
        return;
      }

      logs.innerHTML = state.logs.map((log) => {
        const time = new Date(log.at).toLocaleString("ko-KR", { hour12: false });
        return `<div class="log-item">${time}<br>${log.text}</div>`;
      }).join("");
    }

    function resetGame() {
      if (!confirm("ì •ë§ ì´ˆê¸°í™”í• ê¹Œìš”? íŒ€, ì ìˆ˜, íŠ¸ë™, ë¡œê·¸ê°€ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤.")) return;
      state.teams = [];
      state.logs = [];
      state.finishOrder = [];
      document.getElementById("yutResult").textContent = "ì•„ì§ ë˜ì§€ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
      saveState();
      renderAll();
    }

    function renderAll() {
      renderSelects();
      renderRace();
      renderRanking();
      renderLogs();
    }

    document.getElementById("addTeamBtn").addEventListener("click", addTeam);
    document.getElementById("recordMissionBtn").addEventListener("click", recordMission);
    document.getElementById("throwBtn").addEventListener("click", throwYut);
    document.getElementById("resetBtn").addEventListener("click", resetGame);

    loadState();
    renderAll();
  </script>
</body>
</html>
